---
title: "qPCR Viral Infection"
author: "Thu Nguyen"
date: "11/08/2024"
format:
  html:
    embed-resources: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE) # options for how knitr displays html documents upon rendering

# first install packages if necessary
if (!requireNamespace("BiocManager")) install.packages("BiocManager")
if (!requireNamespace("tidyverse")) install.packages("tidyverse")
if (!requireNamespace("cowplot")) install.packages("cowplot")
if (!requireNamespace("ggrepel")) install.packages("ggrepel")
if (!requireNamespace("scales")) install.packages("scales")
if (!requireNamespace("ggokabeito")) install.packages("ggokabeito")
if (!requireNamespace("flextable")) install.packages("flextable")
if (!requireNamespace("readxl")) install.packages("readxl")
if (!requireNamespace("devtools")) install.packages("devtools")
if (!requireNamespace("cat.extras")) devtools::install_github("jabard89/cat.extras") #convenient utility functions like prettier log scales

# then load packages
library(tidyverse)
library(cowplot)
library(cat.extras)
library(flextable)


conflicted::conflicts_prefer(dplyr::filter) # make sure that other packages don't take over "filter"
okabe_ito_colors <- palette.colors(n = NULL, palette = "Okabe-Ito", recycle = FALSE) #load okabe ito colorblind palette
`%!in%` = Negate(`%in%`)
theme_set(theme_half_open(font_size=10))
```

# reading in the data

```{r}
src.directory <- c(".")

samples_plate1 <- readxl::read_excel(file.path(src.directory,"qPCR_241108_samples.xlsx"), sheet = "Plate1") %>%
  filter(!is.na(RNA_sample)) %>%
  mutate(Plate = "Plate1")
samples <- bind_rows(samples_plate1) # in case there are multiple plates of data

plate1 <- readxl::read_excel(file.path(src.directory,"2024-11-08_ThuN.xls"), sheet = "Results", skip = 20) %>%
  mutate(Well = `Well Position`,
         Ct = as.numeric(CT)) %>%
  select(Well,Ct,Reporter) %>%
  right_join(samples_plate1 %>% filter(!is.na(Well)), by = "Well")

cycle_data <- readxl::read_excel(file.path(src.directory,"2024-11-08_ThuN.xls"), sheet = "Multicomponent Data", skip = 20) %>%
  mutate(Well = `Well Position`) %>%
  select(Well,Cycle,ROX,FAM,VIC,TAMRA,CY5) %>%
  left_join(samples_plate1 %>% filter(!is.na(Well)), by = "Well") %>%
  pivot_longer(cols = c(ROX,FAM,VIC,TAMRA,CY5), names_to = "Channel", values_to = "Value") %>%
  # now go through and match probes to channels
  mutate(Probe = case_when(Channel == "FAM" ~ Probe_FAM,
                           Channel == "VIC" ~ Probe_SUN, #SUN and VIC are the same dye
                           Channel == "CY5" ~ Probe_Cy5))

raw_data <- bind_rows(plate1) %>% 
  replace_na(list(Skip=FALSE,RT=TRUE)) %>%
  # now go through and match probes to channels
  mutate(Probe = case_when(Reporter == "FAM" ~ Probe_FAM,
                           Reporter == "VIC" ~ Probe_SUN, #SUN and VIC are the same dye
                           Reporter == "CY5" ~ Probe_Cy5)) %>%
  filter(!is.na(Probe)) # remove any wells that don't have a probe

data_mean <- raw_data %>%
  filter(!Skip) %>%
  group_by(Plate,RNA_sample,Probe,RT) %>%
  summarise(Ct.SD = sd(Ct),
            Ct.SE = sd(Ct)/sqrt(n()),
            Ct.mean = mean(Ct)) %>%
  ungroup %>%
  left_join(samples %>% select(-c(Well,Techrep,RT,Skip)) %>% unique, by = c("Plate","RNA_sample"))
```
# have a peak at the raw raw data

```{r}
df <- cycle_data %>%
  separate(Well, into = c("Row", "Column"), sep = "(?<=\\D)(?=\\d)", remove = F) %>%
  mutate(Column = factor(as.numeric(Column))) %>%
  # filter(Row %in% LETTERS[which(LETTERS == "A"):which(LETTERS == "O")],
  #        Column %in% seq(2,17)) %>%
  filter(Row %in% c("B","C","E","F","H","I","K","L"),
         Column %in% seq(2,17)) %>%
  group_by(Plate,Well) %>%
  mutate(Value.norm = Value/Value[Channel == "ROX"]) %>%
  ungroup

ggplot(df %>% filter(Channel %in% c("FAM","CY5","VIC")),
       aes(x = Cycle, y= Value.norm, color = Channel)) +
  cowplot::theme_minimal_grid(font_size = 12) +
  geom_line() + 
  scale_y_log2nice() + 
  coord_cartesian(ylim = c(2^-3,2^4)) +
  facet_grid(Row ~ Column)

```
# first check the RT

```{r}
df <- raw_data

p_rt <-  ggplot(df,
               aes(x = RNA_sample, y = Ct, shape = Techrep)) + 
  cowplot::theme_minimal_grid(font_size = 12) +
  cowplot::panel_border() +
  geom_point(aes(color = RT)) +
  facet_grid(Probe ~ .) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Generally technical replicates look super tight, but C2_4-IFIT1-T1 looks off. We'll skip that well (I marked it as Skip on the sample sheet).

```{r}

df %>% filter(RNA_sample == "C2_4", RT == TRUE) %>% arrange(Probe,Techrep) %>%
  select(Well,RNA_sample,Probe,Techrep,Ct) %>% flextable %>% autofit
```

We are also missing a bunch of IFIT1 datapoints, probably because the signal was too low.

```{r}
df <- cycle_data %>%
  separate(Well, into = c("Row", "Column"), sep = "(?<=\\D)(?=\\d)", remove = F) %>%
  mutate(Column = factor(as.numeric(Column))) %>%
  filter(Row %in% LETTERS[which(LETTERS == "B"):which(LETTERS == "I")],
         Column %in% seq(2,17)) %>%
  group_by(Plate,Well) %>%
  mutate(Value.norm = Value/Value[Channel == "ROX"]) %>%
  ungroup %>%
  filter(RT == TRUE, Probe == "IFIT1_S1")

ggplot(df,
       aes(x = Cycle, y= Value.norm, color = FAZ3532_50uM)) +
  cowplot::theme_minimal_grid(font_size = 12) +
  ggokabeito::scale_color_okabe_ito() +
  geom_line(size = 1, aes(group = interaction(RNA_sample,Techrep))) + 
  scale_y_log2nice() + 
  coord_cartesian(ylim = c(2^-4,2^0)) +
  facet_grid(Virus_MOI ~ Time_hr)
```

Let's first look at all the raw Ct values

```{r}
df <- data_mean %>% filter(RT == TRUE)
ggplot(df,
       aes( x = factor(Time_hr), y = Ct.mean, color = factor(Virus_MOI))) +
  geom_point() +
  ggokabeito::scale_color_okabe_ito() +
  facet_grid(FAZ3532_50uM ~ Probe)
```

# calculating relative abundances

Use the ∆∆Ct method to calculate the relative abundance of transcripts across conditions, normalized to a reference gene (GAPDH here):
https://www.nature.com/articles/nprot.2008.73.

Data is normalized to Time = 4hr, Virus_MOI = 1, FAZ3532_50uM = FALSE.

```{r}
# norm to Time = 4hr, Virus_MOI = 1, FAZ3532_50uM = FALSE
ref_probe = "GAPDH_S1"
ref_time = 4
ref_treatment = FALSE
ref_moi = 1

df <- data_mean %>% 
    filter(RT == TRUE) %>%
    group_by(Probe) %>%
    mutate(
      Ct.refCond = mean(Ct.mean[Time_hr == ref_time & 
                           FAZ3532_50uM == ref_treatment & 
                           Virus_MOI == ref_moi]),
      # SE of the mean for reference condition
      Ct.refCond.se = sqrt(sum(Ct.SE[Time_hr == ref_time & 
                                FAZ3532_50uM == ref_treatment & 
                                Virus_MOI == ref_moi]^2))/
                  sqrt(sum(Time_hr == ref_time & 
                          FAZ3532_50uM == ref_treatment & 
                          Virus_MOI == ref_moi))
    ) %>%
    ungroup() %>%
    # Calculate reference probe values first
    mutate(
      ref_probe_ct = mean(Ct.refCond[Probe == ref_probe]),
      ref_probe_se = sqrt(sum(Ct.refCond.se[Probe == ref_probe]^2))/
                     sqrt(sum(Probe == ref_probe))
    ) %>%
    mutate(
      Ct.refCond.refProbe = ref_probe_ct,
      Ct.refCond.refProbe.se = ref_probe_se
    ) %>%
    group_by(Bio_Sample) %>%
    mutate(
      Ct.refProbe = Ct.mean[Probe == ref_probe],
      Ct.refProbe.se = Ct.SE[Probe == ref_probe]
    ) %>%
    ungroup() %>%
    mutate(
      # Calculate delta-delta Ct and relative abundance
      delta_ct = Ct.mean - Ct.refProbe,
      delta_ct_refCond = Ct.refCond - Ct.refCond.refProbe,
      delta_delta_ct = delta_ct - delta_ct_refCond,
      Rel_abund = 2^(-delta_delta_ct),
      
      # Propagate standard errors
      delta_ct_se = sqrt(Ct.SE^2 + Ct.refProbe.se^2),
      delta_ct_refCond_se = sqrt(Ct.refCond.se^2 + Ct.refCond.refProbe.se^2),
      delta_delta_ct_se = sqrt(delta_ct_se^2 + delta_ct_refCond_se^2),
      Rel_abund_se = Rel_abund * log(2) * delta_delta_ct_se
    )

ggplot(df %>% filter(Probe == "CHIKV_E1"),
       aes(x = factor(Time_hr), y = Rel_abund, color = FAZ3532_50uM)) +
  geom_point() +
  stat_summary(fun = mean, geom = "crossbar", width = 0.5) +
  ggokabeito::scale_color_okabe_ito() +
  scale_y_log10nice() +
  facet_grid(Probe ~ Virus_MOI, labeller = labeller(Virus_MOI = function(x) paste("MOI", x))) +
  labs(x = "Time (hours)")
```

